<html>
<head>

<link id="style" rel="stylesheet" type="text/css" href="popup.css" />

<script type="text/javascript">

// FEATURE: support drag & drop re-ordering
// FEATURE: support drag & drop merging

var backgroundPage = chrome.extension.getBackgroundPage();
var savedWindowListEl, formEl, nameInput, template;
var undo = new Object();

function init() {
	// CSS buster - only used when developing locally
	style = document.getElementById("style");
	style.href = style.href + "?salt=" + Math.random();

	savedWindowListEl = document.getElementById("savedWindowList");
	formEl = document.getElementById("form");
	nameInput = document.getElementById("nameInput");
	
	template = document.getElementById("template");
	
	// populate list of windows
	chrome.windows.getCurrent(function(currentWindow) {
		var currentWindowName = backgroundPage.windowIdToName[currentWindow.id];
		var savedWindows = backgroundPage.savedWindows;
		var savedWindowNames = backgroundPage.savedWindowNames;
		for (var i in savedWindowNames) {
			var name = savedWindowNames[i];
			var w = savedWindows[name];
			appendWindowToList(w, currentWindowName);
		}
		if (!currentWindowName) {
			if (currentWindow.incognito) {
				document.getElementById("incognitoMsg").style.display = "block";
			} else {
				nameInput.value = backgroundPage.DEFAULT_NAME;
				formEl.style.display = "block";
				nameInput.focus();
				nameInput.select();
			}
		}
	});
}

// add window to HTML list of windows
function appendWindowToList(w, currentWindowName) {
	li = template.cloneNode(true);
	li.removeAttribute("id");
	li.setAttribute("data-name", w.name);
	
	var text = w.displayName + " (" + w.tabs.length + ")";
	if (w.name == currentWindowName) {
		li.className = "current";
		li.onclick = null;
		text = "This is <b>" + text + "<\/b>.";
	} else if (w.id) {
		li.className = "open";
		li.onclick = null;
		// FEATURE: make it possible to focus the window
	}
	setText(li, text);
	
	// FEATURE: add "add to this set" to add current tabs to existing one
	
	savedWindowListEl.appendChild(li);
}

// save window in background page and update display
function saveWindow() {
	chrome.windows.getCurrent(function(w) {
		chrome.tabs.getAllInWindow(null, function(tabs) {	
			w.tabs = tabs;
			w = backgroundPage.saveWindow(w, nameInput.value);
			formEl.style.display = "none";
			appendWindowToList(w, nameInput.value);
		});
	});
	return false;
}

// open a saved window
// called when the user clicks a window name
function openSavedWindow(element) {
	name = element.getAttribute("data-name");
	backgroundPage.openWindow(name);
}

// delete a saved window
// called when the user presses the delete button
function deleteSavedWindow(element) {
	// get data
	var li = element.parentNode;
	var name = li.getAttribute("data-name");
	var w = backgroundPage.savedWindows[name]
	var text = li.childNodes[1].innerHTML;
	
	// save information for undo
	undo[name] = {
		className: li.className,
		text: text,
		w: w
	};

	// actually perform the deletion
	backgroundPage.deleteSavedWindow(name);
	
	// update display
	li.className = "deleted";
	setText(li, "<b>" + getDisplayName(w) + "<\/b> was deleted.");
}

// undo a deletion
// called when the user presse the undo button
function undoDeleteSavedWindow(element) {
	// get data
	var li = element.parentNode;
	var name = li.getAttribute("data-name");
	var undoInfo = undo[name];

	// resave the window
	backgroundPage.saveWindow(undoInfo.w, name);
	
	// update display
	li.className = undoInfo.className;
	setText(li, undoInfo.text);
	
	// clean up
	delete undo[name];
}

// given a list element, sets the text
function setText(element, text) {
	element.childNodes[1].innerHTML = text;
}

// formats the name for display
function getDisplayName(w) {
	return w.displayName + " (" + w.tabs.length + ")";
}

</script>

</head>


<body onload="init();">

<div>
	<ul id="savedWindowList">
	 	<li id="template" onclick="openSavedWindow(this);">
		 	<span class="text">Name</span><!--
		 --><span class="delete" onclick="deleteSavedWindow(this);">
				&times;
			</span><!--
		 --><span class="undo" onclick="undoDeleteSavedWindow(this);">
				undo
			</span>
		</li>
	</ul>
	<form id="form" onsubmit="return saveWindow();">
		Save as: <input type="text" id="nameInput" />
	</form>
	<div id="incognitoMsg">Note: you can't save incognito windows.</div>
</div>

</body>
</html>