<html>
<head>

<link rel="stylesheet" type="text/css" href="popup.css" />

<script type="text/javascript">

var backgroundPage = chrome.extension.getBackgroundPage();
var savedWindowListEl, formEl, nameInput;

function init() {
	savedWindowListEl = document.getElementById("savedWindowList");
	nameInput = document.getElementById("nameInput");	
	formEl = document.getElementById("form");
	
	// populate list of windows
	chrome.windows.getCurrent(function(currentWindow) {
		var currentWindowName = backgroundPage.windowIdToName[currentWindow.id];
		var savedWindows = backgroundPage.savedWindows;
		var savedWindowNames = backgroundPage.savedWindowNames;
		for (var i in savedWindowNames) {
			var name = savedWindowNames[i];
			if (name != currentWindowName){
				var w = savedWindows[name];
				appendWindowToList(w, currentWindowName);
			}
		}
		if (currentWindowName) {
			var w = savedWindows[currentWindowName];
			appendWindowToList(w, currentWindowName);
		} else if (currentWindow.incognito) {
			document.getElementById("incognitoMsg").style.display = "block";
		} else {
			nameInput.value = backgroundPage.DEFAULT_NAME;
			formEl.style.display = "block";
			nameInput.focus();
			nameInput.select();
		}
	});
}

// add window to HTML list of windows
function appendWindowToList(w, currentWindowName) {
	var li = document.createElement("li");
	
	var span = document.createElement("span");
	span.innerText = w.getDisplayName();
	if (w.name == currentWindowName) {
		innerspan = span.id = "windowName";
		outerSpan = document.createElement("span");
		outerSpan.appendChild(document.createTextNode("This is "));
		outerSpan.appendChild(span);
		li.className = "current";
		span = outerSpan;
	} else {	
		if (w.id) {
			li.className = "open";
			// TODO: make it possible to focus the window
		} else {
			span.onclick = function() {
				backgroundPage.openWindow(w);
			};
		}
	}
	li.appendChild(span);
	
	var del = document.createElement("span");
	del.onclick = function() {
		deleteSavedWindow(this, w.name);
	};
	del.className = "deleteButton";
	// TODO: add icon
	del.innerHTML = "&times;";
	li.appendChild(del);
	
	savedWindowListEl.appendChild(li);
}

// save window in background page and update display
function saveWindow() {
	chrome.windows.getCurrent(function(w) {
		chrome.tabs.getAllInWindow(null, function(tabs) {	
			w.tabs = tabs;
			w = backgroundPage.saveWindow(w, nameInput.value);
			formEl.style.display = "none";
			appendWindowToList(w, nameInput.value);
		});
	});
	return false;
}

// delete a saved window
function deleteSavedWindow(element, name) {
	// remove from list
	var li = element.parentNode;
	li.parentNode.removeChild(li);
	
	// show form if this was the current window
	if (li.className == "current") {
		var displayName = backgroundPage.savedWindows[name].displayName;
 		nameInput.value = displayName;
		formEl.style.display = "block";
		nameInput.focus();
		nameInput.select();
	}

	// actually perform the deletion
	backgroundPage.deleteSavedWindow(name);
	
	// TODO: add undo
}

</script>

</head>


<body onload="init();">

<div>
	<ul id="savedWindowList">
	</ul>
	<form id="form" onsubmit="return saveWindow();">
		Save as: <input type="text" id="nameInput" />
	</form>
	<div id="incognitoMsg">Sorry, you can't save incognito windows.</div>
</div>

</body>
</html>