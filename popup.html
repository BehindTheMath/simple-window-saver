<html>
<head>

<link id="style" rel="stylesheet" type="text/css" href="popup.css" />

<script type="text/javascript">

// FEATURE: support drag & drop re-ordering
// FEATURE: support drag & drop merging

var backgroundPage = chrome.extension.getBackgroundPage();
var savedWindowListEl, formEl, nameInput;

function init() {
	// CSS buster - only used when developing locally
	style = document.getElementById("style");
	style.href = style.href + "?salt=" + Math.random();

	savedWindowListEl = document.getElementById("savedWindowList");
	nameInput = document.getElementById("nameInput");	
	formEl = document.getElementById("form");
	
	// populate list of windows
	chrome.windows.getCurrent(function(currentWindow) {
		var currentWindowName = backgroundPage.windowIdToName[currentWindow.id];
		var savedWindows = backgroundPage.savedWindows;
		var savedWindowNames = backgroundPage.savedWindowNames;
		for (var i in savedWindowNames) {
			var name = savedWindowNames[i];
			var w = savedWindows[name];
			appendWindowToList(w, currentWindowName);
		}
		if (!currentWindowName) {
			if (currentWindow.incognito) {
				document.getElementById("incognitoMsg").style.display = "block";
			} else {
				nameInput.value = backgroundPage.DEFAULT_NAME;
				formEl.style.display = "block";
				nameInput.focus();
				nameInput.select();
			}
		}
	});
}

// add window to HTML list of windows
function appendWindowToList(w, currentWindowName) {
	// P1: move styling from javascript to html
	var li = document.createElement("li");
	
	var span = document.createElement("span");
	span.innerText = w.getDisplayName();
	if (w.name == currentWindowName) {
		span.id = "windowName";
		outerSpan = document.createElement("span");
		outerSpan.appendChild(document.createTextNode("This is "));
		outerSpan.appendChild(span);
		li.className = "current";
		span = outerSpan;
	} else {	
		if (w.id) {
			li.className = "open";
			span.onclick = null;
			// FEATURE: make it possible to focus the window
		} else {
			span.onclick = function() {
				backgroundPage.openWindow(w);
			};
		}
	}
	li.appendChild(span);
	
	var del = document.createElement("span");
	del.onclick = function() {
		deleteSavedWindow(this, w.name);
	};
	del.className = "deleteButton";
	del.innerHTML = "&times;";
	li.appendChild(del);
	
	// FEATURE: add "add to this set" to add current tabs to existing one
	
	savedWindowListEl.appendChild(li);
}

// save window in background page and update display
function saveWindow() {
	chrome.windows.getCurrent(function(w) {
		chrome.tabs.getAllInWindow(null, function(tabs) {	
			w.tabs = tabs;
			w = backgroundPage.saveWindow(w, nameInput.value);
			formEl.style.display = "none";
			appendWindowToList(w, nameInput.value);
		});
	});
	return false;
}

// delete a saved window
// called when the user presses the delete button
function deleteSavedWindow(element, name) {
	// remove from list
	var li = element.parentNode;
	
	w = backgroundPage.savedWindows[name];
	var span = document.createElement("span");
	span.innerHTML = "<b>" + w.displayName + "</b> was deleted.";
	oldNode = li.replaceChild(span, li.firstChild);
	element.innerText = "undo";
	element.className = "undoLink";
	element.onclick = function() {
		undoDeleteWindow(this, w, name, oldNode);
	}

	// actually perform the deletion
	backgroundPage.deleteSavedWindow(name);
}

// undo a deletion
// called when the user presse the undo button
function undoDeleteWindow(element, w, name, oldNode) {
	backgroundPage.saveWindow(w, name);
	
	li = element.parentNode;
	li.replaceChild(oldNode, li.firstChild);
	
	element.innerHTML = "&times;";
	element.className = "deleteButton";
	element.onclick = function() {
		deleteSavedWindow(this, w.name);
	};
}


</script>

</head>


<body onload="init();">

<div>
	<ul id="savedWindowList">
	</ul>
	<form id="form" onsubmit="return saveWindow();">
		Save as: <input type="text" id="nameInput" />
	</form>
	<div id="incognitoMsg">Note: you can't save incognito windows.</div>
</div>

</body>
</html>